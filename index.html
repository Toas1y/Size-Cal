<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <link rel="manifest" href="manifest.json">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" id="metaTheme" content="#000000">
    <title>Size Calc Pro</title>
    <style>
        /* --- VARIABLES --- */
        :root { 
            --accent: #3b82f6; --danger: #ef4444; 
            --gold: #f2e052; 
            --emerald: #50c878;
            --bg: #000; --card: #0a0a0a; --border: #333; --text: #fff; --text-dim: #888; 
        }
        [data-theme="light"] { 
            --bg: #e3e3e3; --card: #fff; --border: #d1d1d1; --text: #1a1a1a; --text-dim: #777; 
        }

        /* --- RESET --- */
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
        body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg); color: var(--text); padding: 10px; display: flex; justify-content: center; margin: 0; overflow-x: hidden; transition: background 0.3s; }
        .card { width: 100%; max-width: 400px; padding: 10px; box-sizing: border-box; }

        /* --- HEADER & GEAR --- */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        h2 { color: var(--accent); font-weight: 800; text-transform: uppercase; letter-spacing: 1px; font-size: 1rem; margin:0; }
        .gear-container { position: relative; }
        .settings-menu { display: none; position: absolute; right: 0; top: 30px; background: var(--card); border: 1px solid var(--border); border-radius: 12px; width: 180px; z-index: 100; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .menu-row { padding: 12px; display: flex; justify-content: space-between; border-bottom: 1px solid var(--border); align-items: center; }

        /* --- INPUTS --- */
        .section-label { font-size: 0.6rem; font-weight: 700; text-transform: uppercase; color: var(--text-dim); margin: 10px 0 5px 0; display: block; }
        .dim-row { display: flex; gap: 6px; margin-bottom: 8px; align-items: center; }
        .input-wrapper { position: relative; flex: 1; display: flex; align-items: center; }
        
        .input-box { width: 100%; padding: 10px 28px 10px 10px; border: 1px solid var(--border); border-radius: 8px; font-size: 0.95rem; background: #000; color: var(--text); outline: none; height: 44px; box-sizing: border-box; transition: border 0.2s; }
        [data-theme="light"] .input-box { background: #fff; }
        .input-box:focus { border-color: var(--accent); }
        
        .smart-input-container { position: relative; flex: 1.5; display: flex; align-items: center; background: #000; border: 1px solid var(--border); border-radius: 8px; height: 44px; overflow: hidden; }
        [data-theme="light"] .smart-input-container { background: #fff; }
        .smart-select { background: transparent; color: var(--accent); border: none; font-size: 0.55rem; font-weight: 900; height: 100%; padding: 0 5px; outline: none; text-transform: uppercase; cursor: pointer; border-right: 1px solid var(--border); }
        .smart-val-input { flex: 1; background: transparent; border: none; color: var(--text); font-size: 0.95rem; padding: 0 28px 0 10px; outline: none; height: 100%; width: 100%; }
        .clear-x { position: absolute; right: 8px; color: var(--text-dim); cursor: pointer; font-size: 16px; padding: 4px; z-index: 5; }
        
        .toggle-btn { padding: 0 8px; border-radius: 8px; border: 1px solid var(--border); background: #000; color: var(--text-dim); font-size: 0.6rem; font-weight: 800; cursor: pointer; height: 44px; white-space: nowrap; }
        [data-theme="light"] .toggle-btn { background: #fff; }
        .toggle-btn.active { background: var(--accent) !important; color: #fff; border-color: var(--accent); }

        /* --- PRESETS --- */
        .preset-row { display: flex; gap: 5px; margin: 5px 0 10px 0; overflow-x: auto; padding-bottom: 5px; scrollbar-width: none; }
        .chip { background: #000; color: var(--text-dim); padding: 5px 10px; border-radius: 6px; font-size: 0.55rem; font-weight: 800; border: 1px solid var(--border); white-space: nowrap; flex-shrink: 0; cursor: pointer; }
        [data-theme="light"] .chip { background: #fff; }
        .chip.active-preset { border-color: var(--accent); color: var(--accent); }

        /* --- RESULT PANEL --- */
        .result-panel { background: var(--card); border-radius: 12px; padding: 12px; margin-top: 10px; border: 1px solid var(--border); position: relative; }
        .size-conversion { font-weight: 800; color: var(--text); font-size: 1.1rem; margin-bottom: 4px; display: block; }
        .area-line { font-size: 0.8rem; color: var(--text-dim); margin-bottom: 10px; }
        .mrp-box { border-top: 1px solid var(--border); padding-top: 10px; position: relative; }
        .mrp-val { font-size: 1.6rem; font-weight: 900; color: var(--accent); margin-top: 2px; display: flex; align-items: baseline; gap: 6px; }
        .gst-small { font-size: 0.55rem; color: var(--text-dim); font-weight: bold; text-transform: uppercase; }

        /* --- DISCOUNT WITH MODE BUTTON --- */
        #discInputArea { display: none; margin-top: 8px; border-top: 1px dashed var(--border); padding-top: 8px; }
        .disc-wrapper-flex { display: flex; align-items: center; border: 1px solid var(--border); border-radius: 8px; overflow: hidden; background: #000; height: 40px; margin-top: 8px; }
        .mode-btn { width: 60px; height: 100%; border: none; background: #1a1a1a; color: var(--text); font-size: 0.6rem; font-weight: 900; cursor: pointer; border-right: 1px solid var(--border); }
        .disc-input-flex { flex: 1; border: none; background: transparent; color: var(--text); font-size: 0.95rem; padding: 0 10px; outline: none; font-weight: bold; }
        
        .disc-res-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 6px; }
        .disc-res-box { background: rgba(255,255,255,0.03); padding: 6px; border-radius: 5px; font-size: 0.65rem; color: var(--text-dim); border: 1px solid var(--border); font-weight: bold; transition: 0.3s; }
        .disc-res-box b { color: var(--text); display: block; font-size: 0.8rem; margin-top:2px; }
        
        .mode-gold { border-color: var(--gold) !important; color: var(--gold) !important; box-shadow: 0 0 10px rgba(242, 224, 82, 0.15); }
        .mode-gold b { color: var(--gold) !important; }
        .mode-emerald { border-color: var(--emerald) !important; color: var(--emerald) !important; box-shadow: 0 0 10px rgba(80, 200, 120, 0.15); }
        .mode-emerald b { color: var(--emerald) !important; }

        /* --- BUTTONS --- */
        .btn-group { display: flex; gap: 6px; margin-top: 12px; }
        .btn { flex: 1; padding: 10px; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; font-size: 0.7rem; height: 42px; text-transform: uppercase; }
        .btn-reset { background: #000; color: var(--text-dim); border: 1px solid var(--border); }
        [data-theme="light"] .btn-reset { background: #fff; }
        .btn-save { flex: 1.5; background: var(--accent); color: #fff; }
        .btn-copy { background: #000; color: var(--text-dim); border: 1px solid var(--border); }
        [data-theme="light"] .btn-copy { background: #fff; }

        /* --- HISTORY --- */
        .hist-item { background: var(--card); padding: 12px; border: 1px solid var(--border); border-radius: 10px; margin-bottom: 8px; position: relative; }
        .delete-btn { position: absolute; top: 10px; right: 10px; color: var(--danger); font-size: 9px; font-weight: 900; cursor: pointer; }
        .hist-size { color: var(--text); font-size: 0.9rem; font-weight: 800; cursor: pointer; text-decoration: underline; text-decoration-thickness: 1px; text-underline-offset: 3px; }

        /* --- SLIDER --- */
        .switch { position: relative; width: 36px; height: 20px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background: #333; transition: .3s; border-radius: 20px; }
        .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px; background: #fff; transition: .3s; border-radius: 50%; }
        input:checked + .slider { background: var(--accent); }
        input:checked + .slider:before { transform: translateX(16px); }

        #toast { visibility: hidden; min-width: 100px; background: var(--accent); color: #fff; text-align: center; border-radius: 20px; padding: 8px; position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); font-size: 0.7rem; z-index: 2000; }
        #toast.show { visibility: visible; }
        .modal-overlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:2000; align-items:center; justify-content:center; backdrop-filter:blur(5px); }
        .modal-box { background:var(--card); padding:25px; border-radius:15px; border:1px solid var(--border); width:80%; max-width:300px; text-align:center; }
    </style>
</head>
<body>

<div id="toast">COPIED</div>

<div id="appModal" class="modal-overlay">
    <div class="modal-box">
        <span id="modalTitle" style="font-size:0.8rem; font-weight:800; color:var(--text);">CONFIRM</span>
        <div id="modalBody" style="font-size: 0.75rem; color: var(--text-dim); margin: 15px 0;">...</div>
        <input type="text" id="modalInput" class="input-box" style="width:100%; margin:15px 0; text-align:center; display:none;">
        <div style="display:flex; gap:10px;">
            <button class="btn btn-reset" onclick="closeModal()">CANCEL</button>
            <button class="btn btn-save" id="modalSubmit">OK</button>
        </div>
    </div>
</div>

<div class="card">
    <div class="header">
        <h2>Size Calc Pro</h2>
        <div class="gear-container">
            <span style="cursor:pointer; font-size:1.2rem;" onclick="toggleMenu()">‚öôÔ∏è</span>
            <div id="settingsMenu" class="settings-menu">
                <div class="menu-row">
                    <div style="display:flex; align-items:center; gap:8px;">
                        <span style="font-size:0.7rem;">üåô</span>
                        <label class="switch"><input type="checkbox" id="themeToggle" onchange="swapTheme(this)"><span class="slider"></span></label>
                        <span style="font-size:0.7rem;">‚òÄÔ∏è</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <span class="section-label">L / W / Qty</span>
    <div class="dim-row">
        <div class="input-wrapper"><input type="number" id="L" placeholder="L" class="input-box" oninput="runMath('dim')"><span class="clear-x" onclick="clearField('L')">√ó</span></div>
        <div class="input-wrapper"><input type="number" id="W" placeholder="W" class="input-box" oninput="runMath('dim')"><span class="clear-x" onclick="clearField('W')">√ó</span></div>
        <div class="smart-input-container">
            <select id="calcMode" class="smart-select" onchange="runMath('mode')">
                <option value="pcs">QTY</option>
                <option value="wall">AREA</option>
            </select>
            <div class="input-wrapper"><input type="number" id="QTY_VAL" value="1" class="smart-val-input" oninput="runMath('qty')"><span class="clear-x" onclick="clearField('QTY_VAL')">√ó</span></div>
        </div>
        <button id="wToggle" class="toggle-btn" onclick="toggleInch()">INCH</button>
    </div>

    <div class="preset-row">
        <div class="chip" data-l="8" data-w="4.5" data-i="true" onclick="applyPreset(this)">8' √ó 4.5"</div>
        <div class="chip" data-l="8" data-w="6" data-i="true" onclick="applyPreset(this)">8' √ó 6"</div>
        <div class="chip" data-l="9.5" data-w="4.5" data-i="true" onclick="applyPreset(this)">9.5' √ó 4.5"</div>
        <div class="chip" data-l="9.5" data-w="6" data-i="true" onclick="applyPreset(this)">9.5' √ó 6"</div>
        <div class="chip" data-l="8" data-w="4" data-i="false" onclick="applyPreset(this)">8' √ó 4'</div>
    </div>

    <span class="section-label">Rate & Sheet Price</span>
    <div class="dim-row">
        <div class="input-wrapper"><input type="number" id="rate" placeholder="Rate/ft¬≤" class="input-box" oninput="runMath('rate')"><span class="clear-x" onclick="clearField('rate')">√ó</span></div>
        <div class="input-wrapper"><input type="number" id="mrp" placeholder="Price/Sheet" class="input-box" oninput="runMath('mrp')"><span class="clear-x" onclick="clearField('mrp')">√ó</span></div>
    </div>

    <div class="result-panel">
        <span class="size-conversion" id="sizeConv">0' √ó 0"</span>
        <div class="area-line">Total Area: <b><span id="dispArea">0.00</span> ft¬≤</b> <span id="pcsInfo" style="color:var(--accent); font-weight:bold;"></span></div>
        <div class="mrp-box">
            <span class="gst-small">Final Total</span>
            <div class="mrp-val">‚Çπ <span id="finalVal">0</span> <span id="gstDisplay" class="gst-small" style="margin-left:5px;"></span></div>
            <div onclick="toggleDisc()" style="position: absolute; right: 0; bottom: 10px; color: var(--text-dim); cursor: pointer; font-size: 9px; font-weight: 800;">DISCOUNT ‚ñº</div>
        </div>
        <div id="discInputArea">
            <div class="disc-wrapper-flex">
                <button id="modeBtn" class="mode-btn" onclick="cycleMode()">‚ö° SMART</button>
                <input type="number" id="discIn" placeholder="Discount" class="disc-input-flex" oninput="runMath('disc')">
                <span class="clear-x" style="position:relative; right:10px;" onclick="clearDisc()">√ó</span>
            </div>
            <div class="disc-res-grid">
                <div class="disc-res-box" id="boxLess">Less/Off <b id="dMoneyOff">‚Çπ0</b></div>
                <div class="disc-res-box" id="boxNet">Result <b id="dTotal">‚Çπ0</b></div>
            </div>
        </div>
    </div>

    <div class="btn-group">
        <button class="btn btn-reset" onclick="resetAll()">Reset</button>
        <button class="btn btn-save" onclick="saveToHistory()">Save</button>
        <button class="btn btn-copy" onclick="copyCurrent()">Copy</button>
    </div>

    <div id="historyLog" style="margin-top:20px;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <span class="section-label" style="margin:0">History Log</span>
            <span onclick="triggerClearHistory()" style="font-size: 0.55rem; color: var(--danger); cursor: pointer; font-weight: 900;">CLEAR ALL</span>
        </div>
        <div id="histItems"></div>
    </div>
</div>

<script>
if ('serviceWorker' in navigator) { navigator.serviceWorker.register('./sw.js'); }

let wInchMode = false;
let currentTheme = 'dark';
let lastSource = 'rate';
let discMode = 'smart'; // smart, perc, flat, target

function toggleMenu() { const m = document.getElementById('settingsMenu'); m.style.display = m.style.display === 'block' ? 'none' : 'block'; }
window.onclick = (e) => { if (!e.target.innerText.includes('‚öôÔ∏è')) document.getElementById('settingsMenu').style.display = "none"; }

window.onload = function() {
    const h = localStorage.getItem('sizeCalcHistory'); if (h) document.getElementById('histItems').innerHTML = h;
    currentTheme = localStorage.getItem('calcTheme') || 'dark';
    document.documentElement.setAttribute('data-theme', currentTheme);
    document.getElementById('themeToggle').checked = (currentTheme === 'light');
    document.getElementById('metaTheme').setAttribute('content', currentTheme === 'dark' ? '#000000' : '#e3e3e3');
    ['L', 'W', 'QTY_VAL', 'rate', 'mrp', 'discIn'].forEach(id => { document.getElementById(id).value = localStorage.getItem('last' + id) || (id === 'QTY_VAL' ? '1' : ''); });
    document.getElementById('calcMode').value = localStorage.getItem('lastMode') || 'pcs';
    runMath('load');
};

function swapTheme(cb) {
    currentTheme = cb.checked ? 'light' : 'dark';
    document.documentElement.setAttribute('data-theme', currentTheme);
    localStorage.setItem('calcTheme', currentTheme);
    document.getElementById('metaTheme').setAttribute('content', currentTheme === 'dark' ? '#000000' : '#e3e3e3');
}

function formatUnit(val) {
    if (val < 12) return val.toFixed(1).replace(/\.0$/, "") + '"';
    return (val / 12).toFixed(2).replace(/\.00$/, "").replace(/\.$/, "") + "'";
}

function cycleMode() {
    const btn = document.getElementById('modeBtn');
    if (discMode === 'smart') { discMode = 'perc'; btn.innerText = "% PERC"; }
    else if (discMode === 'perc') { discMode = 'flat'; btn.innerText = "‚Çπ- FLAT"; }
    else if (discMode === 'flat') { discMode = 'target'; btn.innerText = "‚Çπ= TARGET"; }
    else { discMode = 'smart'; btn.innerText = "‚ö° SMART"; }
    runMath('disc');
}

function val(id) { return parseFloat(document.getElementById(id).value) || 0; }

function runMath(trigger) {
    let L = val('L'), W = val('W'), QTY = val('QTY_VAL'), rate = val('rate'), unitPrice = val('mrp'), disc = val('discIn');
    let mode = document.getElementById('calcMode').value;

    if (trigger === 'rate') lastSource = 'rate';
    if (trigger === 'mrp') lastSource = 'mrp';

    let lIn = (L >= 1 && L <= 15) ? L * 12 : (L >= 16 && L <= 250 ? L : L / 25.4);
    let wIn = wInchMode ? W : (W > 200 ? W/25.4 : W*12);
    document.getElementById('sizeConv').innerText = (L && W) ? `${formatUnit(lIn)} √ó ${formatUnit(wIn)}` : "0' √ó 0\"";

    let singleArea = (lIn * wIn) / 144; 
    let totalArea = 0, pcs = 0;

    if (mode === 'pcs') {
        pcs = (QTY || 1);
        totalArea = singleArea * pcs;
        document.getElementById('pcsInfo').innerText = "";
    } else {
        let wallArea = QTY || 0;
        pcs = singleArea > 0 ? Math.ceil(wallArea / singleArea) : 0;
        totalArea = singleArea * pcs;
        document.getElementById('pcsInfo').innerText = `(${pcs} Pcs)`;
    }
    document.getElementById('dispArea').innerText = totalArea.toFixed(2);

    if (singleArea > 0) {
        if (lastSource === 'rate') {
            unitPrice = Math.round(rate * singleArea);
            if (trigger !== 'mrp') document.getElementById('mrp').value = unitPrice || ""; 
        } else {
            rate = unitPrice / singleArea;
            if (trigger !== 'rate') document.getElementById('rate').value = rate.toFixed(2) || "";
        }
    }

    let finalTotal = unitPrice * (pcs || 1);
    document.getElementById('finalVal').innerText = finalTotal.toLocaleString('en-IN');
    let gstAmt = Math.round(finalTotal * 18/118);
    document.getElementById('gstDisplay').innerText = finalTotal > 0 ? `(‚Çπ${gstAmt.toLocaleString('en-IN')} GST)` : "";

    // --- MODE-BASED DISCOUNT LOGIC ---
    let off = 0, net = finalTotal;
    const bL = document.getElementById('boxLess'), bN = document.getElementById('boxNet');
    bL.className = "disc-res-box"; bN.className = "disc-res-box"; 

    if (disc > 0) {
        if (discMode === 'perc') {
            off = finalTotal * (disc / 100);
            net = finalTotal - off;
            bL.classList.add('mode-gold'); bN.classList.add('mode-gold');
            document.getElementById('dMoneyOff').innerText = `‚Çπ${Math.round(off).toLocaleString('en-IN')} (${disc}%)`;
        } else if (discMode === 'flat') {
            off = disc;
            net = finalTotal - disc;
            let p = finalTotal > 0 ? ((off/finalTotal)*100).toFixed(1) : 0;
            bL.classList.add('mode-emerald'); bN.classList.add('mode-emerald');
            document.getElementById('dMoneyOff').innerText = `‚Çπ${Math.round(off).toLocaleString('en-IN')} (${p}%)`;
        } else if (discMode === 'target') {
            net = disc;
            off = finalTotal - disc;
            let p = finalTotal > 0 ? ((off/finalTotal)*100).toFixed(1) : 0;
            bL.classList.add('mode-emerald'); bN.classList.add('mode-emerald');
            document.getElementById('dMoneyOff').innerText = `‚Çπ${Math.round(off).toLocaleString('en-IN')} (${p}%)`;
        } else {
            // SMART MODE
            if (disc < 100) {
                off = finalTotal * (disc / 100);
                net = finalTotal - off;
                bL.classList.add('mode-gold'); bN.classList.add('mode-gold');
                document.getElementById('dMoneyOff').innerText = `‚Çπ${Math.round(off).toLocaleString('en-IN')} (${disc}%)`;
            } else {
                net = disc;
                off = finalTotal - disc;
                let p = finalTotal > 0 ? ((off/finalTotal)*100).toFixed(1) : 0;
                bL.classList.add('mode-emerald'); bN.classList.add('mode-emerald');
                document.getElementById('dMoneyOff').innerText = `‚Çπ${Math.round(off).toLocaleString('en-IN')} (${p}%)`;
            }
        }
    } else {
        document.getElementById('dMoneyOff').innerText = "‚Çπ0";
    }

    let netRate = (totalArea > 0) ? (net / totalArea).toFixed(2) : 0;
    document.getElementById('dTotal').innerText = `‚Çπ${Math.round(net).toLocaleString('en-IN')} (‚Çπ${netRate}/ft¬≤)`;

    if (trigger !== 'load') updateInputs();
}

function applyPreset(el) {
    document.getElementById('L').value = el.dataset.l; document.getElementById('W').value = el.dataset.w;
    wInchMode = (el.dataset.i === 'true'); document.getElementById('wToggle').classList.toggle('active', wInchMode);
    document.querySelectorAll('.chip').forEach(c => c.classList.remove('active-preset'));
    el.classList.add('active-preset'); runMath('dim');
}

function toggleInch() { wInchMode = !wInchMode; document.getElementById('wToggle').classList.toggle('active', wInchMode); runMath('dim'); }
function updateInputs() { ['L', 'W', 'QTY_VAL', 'rate', 'mrp', 'discIn'].forEach(id => localStorage.setItem('last' + id, document.getElementById(id).value)); localStorage.setItem('lastMode', document.getElementById('calcMode').value); }
function updateStorage() { localStorage.setItem('sizeCalcHistory', document.getElementById('histItems').innerHTML); }

function saveToHistory() {
    const s = document.getElementById('sizeConv').innerText, m = document.getElementById('finalVal').innerText, g = document.getElementById('gstDisplay').innerText, a = document.getElementById('dispArea').innerText, i = document.getElementById('pcsInfo').innerText, rt = document.getElementById('rate').value;
    if (m === "0") return;
    const raw = { L: val('L'), W: val('W'), Q: val('QTY_VAL'), R: rt, MRP: val('mrp'), M: document.getElementById('calcMode'), I: wInchMode, D: val('discIn'), DM: discMode };
    
    const netTxt = document.getElementById('dTotal').innerText;
    const discActive = val('discIn') > 0;
    const discHtml = discActive ? `<div style="color:var(--gold); font-size:0.65rem; font-weight:bold; margin-top:3px;">FINAL: ${netTxt}</div>` : '';
    
    const item = `<div class="hist-item"><span class="delete-btn" onclick="this.parentElement.remove(); updateStorage();">DELETE</span><span onclick="renameQuote(this)" style="color:var(--accent); font-size:0.7rem; font-weight:900; cursor:pointer;">UNNAMED</span><div style="display:flex; justify-content:space-between; align-items:baseline; margin-top:3px;"><b onclick="recallHistory(this)" data-raw='${JSON.stringify(raw)}' class="hist-size">${s} ${i}</b><div style="text-align:right;"><b style="color:var(--accent); font-size:1rem;">‚Çπ${m}</b><br><span style="font-size:0.55rem; color:var(--text-dim); font-weight:bold;">${g}</span></div></div>${discHtml}<div style="font-size:0.6rem; color:var(--text-dim); margin-top:5px; border-top:1px solid var(--border); padding-top:5px;">SIZE: ${s} | RATE: ‚Çπ${rt}/ft¬≤ | AREA: ${a}ft¬≤</div></div>`;
    document.getElementById('histItems').insertAdjacentHTML('afterbegin', item); updateStorage(); showToast("SAVED");
}

function recallHistory(el) {
    const d = JSON.parse(el.dataset.raw);
    openModal("LOAD DATA?", `Load ${el.innerText} into calculator?`, () => {
        document.getElementById('L').value = d.L; document.getElementById('W').value = d.W; document.getElementById('QTY_VAL').value = d.Q;
        document.getElementById('rate').value = d.R; document.getElementById('mrp').value = d.MRP; document.getElementById('calcMode').value = d.M;
        document.getElementById('discIn').value = d.D || ''; discMode = d.DM || 'smart';
        
        let btnTxt = "‚ö° SMART";
        if(discMode === 'perc') btnTxt = "% PERC";
        if(discMode === 'flat') btnTxt = "‚Çπ- FLAT";
        if(discMode === 'target') btnTxt = "‚Çπ= TARGET";
        document.getElementById('modeBtn').innerText = btnTxt;

        wInchMode = d.I; document.getElementById('wToggle').classList.toggle('active', wInchMode);
        runMath('load'); showToast("LOADED");
    }, false);
}

function resetAll() {
    ['L', 'W', 'rate', 'mrp', 'discIn'].forEach(id => document.getElementById(id).value = '');
    document.getElementById('QTY_VAL').value = '1';
    document.getElementById('calcMode').value = 'pcs';
    discMode = 'smart'; document.getElementById('modeBtn').innerText = "‚ö° SMART";
    lastSource = 'rate';
    document.querySelectorAll('.chip').forEach(c => c.classList.remove('active-preset'));
    runMath('dim');
    localStorage.clear();
}

function clearDisc() { document.getElementById('discIn').value = ''; runMath('disc'); }
function clearField(id) { document.getElementById(id).value = (id === 'QTY_VAL' ? '1' : ''); runMath(id === 'QTY_VAL' ? 'qty' : 'dim'); }
function toggleDisc() { const a = document.getElementById('discInputArea'); a.style.display = (a.style.display === 'block' ? 'none' : 'block'); }
function showToast(m) { const t = document.getElementById("toast"); t.innerText = m; t.className = "show"; setTimeout(() => t.className = "", 2000); }
function closeModal() { document.getElementById('appModal').style.display = 'none'; }
function triggerClearHistory() { openModal("CLEAR ALL?", "Delete all history?", () => { document.getElementById('histItems').innerHTML = ''; updateStorage(); }, false); }
function renameQuote(el) { openModal("RENAME", "Enter Name:", (v) => { if(v) { el.innerText = v.toUpperCase(); updateStorage(); } }, true); }
function copyCurrent() { const t = `Size: ${document.getElementById('sizeConv').innerText}\nTotal: ‚Çπ${document.getElementById('finalVal').innerText}`; navigator.clipboard.writeText(t).then(() => showToast("COPIED")); }
function openModal(t, b, c, s=true) { document.getElementById('modalTitle').innerText = t; document.getElementById('modalBody').innerText = b; const inp = document.getElementById('modalInput'); inp.style.display = s ? 'block' : 'none'; inp.value = ""; document.getElementById('appModal').style.display = 'flex'; document.getElementById('modalSubmit').onclick = () => { c(inp.value); closeModal(); }; }
</script>
</body>
</html>
